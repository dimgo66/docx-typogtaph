/**
 * @file: Project.md
 * @description: Детальное описание проекта обработки текста с ИИ.
 * @dependencies: None
 * @created: 2024-07-29
 */

# Описание проекта: Система обработки и подготовки текста

## 1. Введение

Данный проект нацелен на создание комплексной системы для обработки текстовых данных с использованием технологий искусственного интеллекта. Основная задача — подготовка текстов к дальнейшему макетированию и экспорту в различные форматы, такие как DOCX, PDF, EPUB и HTML. Система должна обеспечивать высокое качество обработки, консистентность результатов и удобство использования.

## 2. Цели проекта

*   Автоматизация процесса подготовки текстов.
*   Улучшение качества текстов за счет применения ИИ для коррекции ошибок, стилизации и форматирования.
*   Обеспечение возможности экспорта обработанных текстов в популярные форматы.
*   Создание гибкой и расширяемой архитектуры для добавления новых функций и модулей.
*   Обеспечение консистентности и поддерживаемости кодовой базы и документации.

## 3. Архитектура системы

Система будет иметь модульную архитектуру, состоящую из следующих ключевых компонентов:

### 3.1. Модуль ввода текста
    *   Поддержка различных форматов на входе (TXT, DOCX, HTML и др.).
    *   Предварительная очистка и нормализация текста.

### 3.2. Модуль обработки текста с помощью ИИ
    *   **Коррекция ошибок:**
        *   Использование LanguageTool для выявления грамматических, пунктуационных и стилистических ошибок.
        *   **Интеграция с ИИ для исправления специфичных типов ошибок:** опечаток, неправильной расстановки пунктуации, дефисов и кавычек. ИИ (модель **qwen/qwen3-235b-a22b:free через OpenRouter**) будет предлагать исправления, которые затем могут быть применены к тексту.
    *   **Стилизация и форматирование:** (Будет добавлено в будущем)
        *   Автоматическое применение стилей.
        *   Управление типографикой.
    *   **Структурирование текста:** (Будет добавлено в будущем)
        *   Автоматическое определение заголовков, списков, таблиц.

### 3.3. Модуль макетирования
    *   Применение шаблонов для различных форматов вывода.
    *   Настройка параметров макета (шрифты, отступы, колонтитулы и т.д.).

### 3.4. Модуль экспорта
    *   Генерация файлов в форматах DOCX, PDF, EPUB, HTML.

### 3.5. Пользовательский интерфейс (WebApp)
    *   Веб-интерфейс для загрузки текстов, управления процессом обработки и скачивания результатов.
    *   Отображение отчетов об ошибках и предложенных исправлениях.

### Поддержка разных форматов файлов и универсализация логики

- Система теперь поддерживает загрузку, обработку, скачивание и удаление файлов форматов docx, pdf, epub, html и других (расширяемо).
- Оригинальное имя файла сохраняется в очереди задач (file_registry.json) и используется для формирования имени результата: [basename]_final.[ext].
- Вся логика обработки, скачивания и удаления файлов теперь универсальна для всех поддерживаемых форматов.
- В интерфейсе пользователя всегда отображается оригинальное имя файла и имя результата.
- Архитектура позволяет легко добавить новые форматы без изменения основной логики очереди и интерфейса.

### Итоговые файлы строго по оригинальному имени пользователя

- Итоговые файлы в workspace/output теперь всегда формируются строго по оригинальному имени пользователя (basename), даже если имя содержит пробелы, запятые и кириллицу.
- Это реализовано на уровне orchestrator.py, который использует переданный basename для формирования имён.
- Архитектура гарантирует прозрачность и удобство для пользователя, а также корректную работу с любыми именами файлов.

## 4. Технологический стек

*   **Бэкенд:** Python (Flask/Django)
*   **Обработка текста:**
    *   LanguageTool (Java) - для первичной проверки.
    *   Библиотеки Python для работы с текстом (например, `nltk`, `spaCy` - будут рассмотрены).
    *   Модели ИИ (**qwen/qwen3-235b-a22b:free через OpenRouter**) - для исправления ошибок и потенциально для других задач обработки.
*   **Фронтенд:** HTML, CSS, JavaScript (возможно, с использованием фреймворка типа Vue.js или React)
*   **База данных:** (Будет определена позже, возможно, SQLite для простоты или PostgreSQL для более сложных сценариев)
*   **Инструменты сборки и CI/CD:** (Будут определены позже, например, Docker, Jenkins, GitHub Actions)

## 5. Этапы разработки

### Этап 1: Базовая функциональность (MVP)
    *   Реализация модуля ввода текста (поддержка TXT и HTML).
    *   Интеграция LanguageTool для проверки орфографии и грамматики.
    *   Реализация модуля экспорта в HTML и PDF (с базовым макетированием).
    *   Создание простого CLI для запуска обработки.

### Этап 2: Интеграция ИИ для исправления ошибок
    *   Разработка механизма взаимодействия с моделями ИИ (qwen/qwen3-235b-a22b:free через OpenRouter).
    *   Реализация функции исправления опечаток, пунктуации, дефисов и кавычек на основе предложений ИИ.
    *   Обновление отчетов LanguageTool с включением предложенных ИИ исправлений.

### Этап 3: Разработка веб-интерфейса
    *   Создание базового веб-интерфейса для загрузки файлов и отображения результатов.

### Этап 4: Расширение функциональности
    *   Поддержка форматов DOCX, EPUB.
    *   Реализация продвинутых функций стилизации и форматирования.
    *   Добавление модуля структурирования текста.

### Этап 5: Тестирование и оптимизация
    *   Комплексное тестирование системы.
    *   Оптимизация производительности и безопасности.

### Этапы пайплайна (актуализация)

- **LanguageToolProcessorModule** — только проверка текста и генерация отчёта, без LLM.
- **AutocorrectProcessorModule** — автоматическая коррекция кандидатов на исправление, каждое исправление подтверждается LLM (OpenRouter), LLM не генерирует исправления, только подтверждает.
- **TypografProcessorModule** — типографика через tools/typografize.js.
- **HtmlToDocxProcessorModule** — конвертация HTML в DOCX через pandoc.
- orchestrator.py управляет последовательным выполнением всех этапов, логированием и статусами.
- Финальный результат — DOCX-файл, готовый к верстке или публикации.

### Разделение пайплайна на два этапа (2024-07-31)

- **run_stage1.py** — DOCX → HTML → типографика. На вход — DOCX, на выход — типографированный HTML.
- **run_stage2.py** — HTML → LanguageTool → автокоррекция (Cursor AI) → DOCX. На вход — HTML, на выход — финальный DOCX.

**Преимущества:**
- Каждый этап можно тестировать и отлаживать отдельно.
- Упрощается диагностика и ускоряется разработка.
- Возможность вручную корректировать HTML между этапами.

**Пример использования:**
```sh
python run_stage1.py input.docx output.html
python run_stage2.py output.html output.docx
```

## 6. Стандарты кодирования и документирования

*   Стиль кода: PEP 8 для Python.
*   Документация:
    *   Все функции и классы должны иметь docstrings.
    *   Значимые изменения и решения должны фиксироваться в `docs/Diary.md` и `docs/changelog.md`.
    *   Архитектура и высокоуровневое описание проекта поддерживаются в `docs/Project.md`.
    *   Задачи отслеживаются в `docs/Tasktracker.md`.
*   Система контроля версий: Git.
*   Комментарии: Комментировать нетривиальные участки кода.

## 7. Требования к консистентности и поддерживаемости

*   Модульность: Код должен быть разбит на логические модули с четко определенными интерфейсами.
*   Переиспользуемость: Поощряется создание переиспользуемых компонентов.
*   Тестируемость: Код должен быть написан с учетом возможности его автоматического тестирования.
*   Читаемость: Код должен быть понятным и легко читаемым.
*   Документация: Актуальная и полная документация является обязательной.

## 8. Требования к сохранению итогового HTML

- Итоговый HTML-файл, который используется для последующей конвертации в любой из поддерживаемых форматов (DOCX, PDF, EPUB и др.), должен сохраняться в директории output под именем `final.html`.
- Это правило распространяется на все форматы вывода: перед каждой конвертацией итоговый HTML сохраняется в output.
- Промежуточные (draft) HTML-файлы сохранять не требуется, только финальный результат перед экспортом.

## 9. Веб-интерфейс и интеграция пайплайна

- Веб-интерфейс реализован на Flask (webapp/app.py).
- Пользователь загружает DOCX-файл через форму, файл помещается в очередь на обработку.
- Воркер webapp копирует файл в textinput, запускает orchestrator.py через subprocess.
- После завершения обработки итоговый DOCX-файл копируется в webapp/results/ и становится доступен для скачивания.
- Статусы обработки и ссылки на результат отображаются в интерфейсе.
