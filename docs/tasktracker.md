/**
 * @file: Tasktracker.md
 * @description: Отслеживание задач проекта по обработке текста с ИИ.
 * @dependencies: Project.md
 * @created: 2024-07-29
 */

# Трекер задач проекта

## Модуль обработки текста с помощью ИИ

### Задача: Интеграция ИИ для исправления ошибок в тексте
- **Статус**: Не начата
- **Приоритет**: Высокий
- **Описание**: Модифицировать скрипт `tools/check_text_languagetool.py` для интеграции с ИИ (модель **qwen/qwen3-235b-a22b:free через OpenRouter**). Цель - не только обнаруживать, но и предлагать исправления для определенных типов ошибок, таких как опечатки, пунктуация, дефисы и кавычки. Предложенные исправления должны добавляться в JSON-отчет.
- **Шаги выполнения**:
  - [ ] Определить типы ошибок LanguageTool, которые будут передаваться ИИ для исправления.
  - [ ] Разработать функцию для взаимодействия с API ИИ (OpenRouter, модель qwen/qwen3-235b-a22b:free).
    - [ ] Передача текста ошибки и контекста.
    - [ ] Получение и обработка предложенного исправления.
  - [ ] Модифицировать `tools/check_text_languagetool.py`:
    - [ ] Интегрировать вызов функции ИИ для выбранных типов ошибок.
    - [ ] Добавить предложенные ИИ исправления в существующий JSON-отчет LanguageTool (например, в новое поле `ai_suggestion`).
  - [ ] Написать тесты для проверки корректности работы новой функции.
  - [ ] Обновить документацию (`README.md` для скрипта, если он есть, и `Project.md`).
- **Зависимости**: Наличие API-ключа для OpenRouter (и соответствующих заголовков `HTTP-Referer`, `X-Title`), установленная библиотека `openai`.

## Общие задачи по проекту

### Задача: Настройка базовой структуры проекта и документации
- **Статус**: Завершена
- **Приоритет**: Критический
- **Описание**: Создание основной структуры директорий проекта, включая `docs`, `src`, `tools` и т.д. Подготовка первоначальных версий ключевых документов: `Project.md`, `Tasktracker.md`, `Diary.md`, `qa.md`, `changelog.md`.
- **Шаги выполнения**:
  - [x] Создать директорию `docs`.
  - [x] Создать файл `Project.md` с общим описанием проекта.
  - [x] Создать файл `Tasktracker.md` для отслеживания задач.
  - [x] Создать файл `Diary.md` для ведения дневника проекта.
  - [x] Создать файл `qa.md` для вопросов.
  - [x] Создать файл `changelog.md` для журнала изменений.
- **Зависимости**: Нет.

# Трекер задач проекта: Обработка текста с ИИ

## Этап 1: Проектирование и настройка окружения

### Задача: Детальное проектирование архитектуры
- **Статус**: В процессе
- **Описание**: Проработка архитектурных решений, определение взаимодействия модулей, выбор основных паттернов проектирования.
- **Шаги выполнения**:
  - [x] Определение основных модулей системы (предварительно завершено в Project.md)
  - [ ] Уточнение интерфейсов между модулями.
  - [ ] Выбор конкретных технологических стеков для бэкенда и фронтенда.
  - [ ] Проектирование схемы базы данных (если потребуется).
  - [ ] Разработка диаграмм последовательности для ключевых сценариев использования.
- **Зависимости**: - 
- **Приоритет**: Критический

### Задача: Выбор основных технологий и инструментов
- **Статус**: В процессе
- **Описание**: Финализация списка технологий, библиотек и инструментов, которые будут использоваться в проекте.
- **Шаги выполнения**:
  - [x] Предварительный выбор ИИ модели (Qwen: Qwen3 235B A22B)
  - [ ] Исследование и выбор фреймворка для бэкенда (Python: Flask/Django/FastAPI).
  - [ ] Исследование и выбор подхода/фреймворка для фронтенда (HTML/CSS/JS, React/Vue/Angular).
  - [ ] Выбор библиотек для генерации PDF (ReportLab, WeasyPrint, PrinceXML).
  - [ ] Выбор библиотек для генерации Epub.
  - [ ] Определение СУБД (если потребуется).
- **Зависимости**: Детальное проектирование архитектуры
- **Приоритет**: Высокий

### Задача: Настройка среды разработки и системы контроля версий
- **Статус**: Не начата
- **Описание**: Конфигурирование локальных и (возможно) удаленных сред разработки, инициализация Git-репозитория, настройка CI/CD (позже).
- **Шаги выполнения**:
  - [ ] Инициализация Git-репозитория.
  - [ ] Настройка виртуального окружения для Python.
  - [ ] Установка базовых зависимостей.
  - [ ] Настройка линтеров и форматеров кода.
- **Зависимости**: Выбор основных технологий и инструментов
- **Приоритет**: Высокий

### Задача: Создание базовой структуры проекта и документации
- **Статус**: В процессе
- **Описание**: Формирование начальной файловой структуры проекта, создание и первичное наполнение ключевых документов.
- **Шаги выполнения**:
  - [x] Создана папка `docs`.
  - [x] Создан и первично заполнен `Project.md`.
  - [x] Создан и первично заполнен `Tasktracker.md`.
  - [ ] Создан и первично заполнен `Diary.md`.
  - [ ] Создан и первично заполнен `qa.md`.
  - [ ] Создан и первично заполнен `changelog.md`.
  - [ ] Создание базовой структуры папок для исходного кода (например, `src/`, `webapp/`).
- **Зависимости**: -
- **Приоритет**: Критический

## Этап 2: Реализация модуля загрузки и предобработки текста

### Задача: Разработка функции загрузки текстовых файлов
- **Статус**: Не начата
- **Описание**: Реализовать возможность загрузки текстовых файлов различных форматов (например, .txt, .docx - если возможно).
- **Шаги выполнения**:
  - [ ] ...
- **Зависимости**: Настройка среды разработки
- **Приоритет**: Высокий

### Задача: Реализация функции предобработки текста
- **Статус**: Не начата
- **Описание**: Очистка текста от нежелательных символов, HTML-тегов (если применимо), приведение к единому формату.
- **Шаги выполнения**:
  - [ ] ...
- **Зависимости**: Разработка функции загрузки текстовых файлов
- **Приоритет**: Высокий

### Задача: Реализация pipeline автоматизированной обработки художественного текста
- **Статус**: Не начата
- **Описание**: Реализовать полный pipeline: загрузка → конвертация в HTML → LanguageTool (автоматические исправления) → ИИ-обработка (автоматические исправления и дополнения) → Typograf → конвертация обратно в docx.
- **Шаги выполнения**:
  - [ ] Реализовать модуль загрузки и конвертации в HTML
  - [ ] Интегрировать LanguageTool с автоматическим применением исправлений
  - [ ] Интегрировать ИИ-обработку (Qwen3 235B A22B) для автоматических исправлений и дополнений
  - [ ] Интегрировать typograf для автоматической типографики
  - [ ] Реализовать конвертацию итогового HTML обратно в docx
  - [ ] Организовать сохранение промежуточных файлов и логов изменений
- **Зависимости**: Детальное проектирование архитектуры, настройка среды разработки
- **Приоритет**: Критический

## Задача: Реализация и тестирование интерфейсов и форматов данных между модулями pipeline
- **Статус**: Не начата
- **Приоритет**: Критический
- **Описание**: Спроектировать и реализовать интерфейсы обмена файлами между этапами pipeline, определить форматы входных и выходных файлов, структуру именования и хранения, провести тестирование передачи данных между модулями.
- **Шаги выполнения**:
  - [ ] Описать форматы данных и интерфейсы для каждого этапа
  - [ ] Реализовать обработку и валидацию файлов на каждом этапе
  - [ ] Протестировать передачу файлов между модулями
  - [ ] Зафиксировать результаты тестирования
- **Зависимости**: Описание pipeline в Project.md

## Задача: Проектирование системы обработки ошибок, логирования и валидации данных
- **Статус**: В процессе
- **Описание**: Определение стратегий и механизмов для обработки ошибок, ведения логов и проверки корректности данных на всех этапах конвейера обработки текста.
- **Шаги выполнения**:
  - [x] Добавление разделов "Обработка ошибок и отказоустойчивость", "Логирование", "Валидация данных" в Project.md
  - [ ] Определение конкретных типов исключений для каждого модуля.
  - [ ] Выбор и настройка библиотеки логирования.
  - [x] Разработка схем валидации данных (Pydantic модели для статус-файлов детализированы в Project.md).
  - [ ] Интеграция механизмов обработки ошибок в прототип.
  - [ ] Интеграция логирования в прототип.
  - [ ] Интеграция валидации данных в прототип.
- **Приоритет**: Высокий
- **Зависимости**: Завершение базового проектирования архитектуры.

## Задача: Реализация базового API для загрузки и скачивания файлов
- **Статус**: Не начата
- **Описание**: Реализовать базовый API для загрузки и скачивания файлов между модулями системы.
- **Шаги выполнения**:
  - [ ] Создание и настройка сервера для API.
  - [ ] Реализация функций загрузки и скачивания файлов.
  - [ ] Тестирование API.
- **Зависимости**: -
- **Приоритет**: Высокий

## Задача: Реализация прототипа файлового обмена и базовых механизмов
- **Статус**: Завершена
- **Описание**: Создание первого прототипа, демонстрирующего обмен файлами между модулями конвейера с интеграцией базовых систем обработки ошибок, логирования и валидации.
- **Шаги выполнения**:
  - [x] Создание структуры папок для прототипа (`src/pipeline/`, `src/utils/`, `workspace/` со подпапками, `textinput/`).
  - [x] Определение и реализация базовых пользовательских исключений в `src/utils/exceptions.py`.
  - [x] Реализация функции настройки логгера в `src/utils/logger_setup.py` с поддержкой `correlation_id`.
  - [x] Реализация Модуля 1: DOCX -> HTML конвертер (`src/pipeline/docx_to_html_converter.py`) с логированием, обработкой ошибок и созданием статус-файла.
  - [x] Реализация Модуля 2: Placeholder-обработчик текста (`src/pipeline/text_processor_stub.py`) с аналогичной обвязкой.
  - [x] Реализация Оркестратора (`src/pipeline/orchestrator.py`) для запуска модулей, передачи `correlation_id` и проверки статус-файлов. Оркестратор изменен для приема имени файла из `textinput/` через аргумент командной строки.
  - [x] Подготовка тестового `.docx` файла и размещение его в `textinput/`.
  - [x] Тестирование и отладка всего прототипа (успешный запуск конвейера с тестовым файлом, решены проблемы с импортами и активацией окружения).
- **Приоритет**: Критический
- **Зависимости**: Завершение проектирования систем обработки ошибок, логирования и валидации (соответствующие разделы в `Project.md`).

## Задача: Восстановить и реализовать модуль LanguageToolProcessorModule
- **Статус**: Завершена
- **Описание**: Восстановить отсутствующий модуль для интеграции проверки текста через LanguageTool и ИИ, реализовать вызов tools/check_text_languagetool.py, обеспечить сохранение SUCCESS.json и возврат пути к отчёту для пайплайна.
- **Шаги выполнения**:
  - [x] Проанализировать архитектуру пайплайна и требования к модулю
  - [x] Реализовать класс LanguageToolProcessorModule с методом run
  - [x] Интегрировать вызов tools/check_text_languagetool.py через subprocess
  - [x] Сохранять SUCCESS.json и возвращать путь к отчёту
  - [x] Обновить документацию и changelog
- **Зависимости**: orchestrator.py, tools/check_text_languagetool.py

## Задача: Реализовать и интегрировать AutocorrectProcessorModule
- **Статус**: Завершена
- **Описание**: Модуль для применения исправлений ИИ к HTML на основе отчёта LanguageTool.
- **Шаги выполнения**:
  - [x] Реализовать класс AutocorrectProcessorModule
  - [x] Интегрировать в orchestrator.py
- **Зависимости**: LanguageToolProcessorModule, tools/check_text_languagetool.py

## Задача: Реализовать и интегрировать TypografProcessorModule
- **Статус**: Завершена
- **Описание**: Модуль для типографики HTML через tools/typografize.js.
- **Шаги выполнения**:
  - [x] Реализовать класс TypografProcessorModule
  - [x] Интегрировать в orchestrator.py
- **Зависимости**: AutocorrectProcessorModule

## Задача: Реализовать и интегрировать HtmlToDocxProcessorModule
- **Статус**: Завершена
- **Описание**: Модуль для конвертации HTML в DOCX через pandoc.
- **Шаги выполнения**:
  - [x] Реализовать класс HtmlToDocxProcessorModule
  - [x] Интегрировать в orchestrator.py
- **Зависимости**: TypografProcessorModule

## Задача: Актуализировать пайплайн — автокоррекция только с подтверждением LLM
- **Статус**: Завершена
- **Описание**: Перенести логику автокоррекции из tools/autocorrect_html_languagetool.py в AutocorrectProcessorModule, исключить вызовы LLM на этапе LanguageTool, оставить только подтверждение исправлений LLM на этапе автокоррекции.
- **Шаги выполнения**:
  - [x] Перенести и интегрировать функцию автокоррекции с подтверждением LLM в AutocorrectProcessorModule
  - [x] Удалить вызовы LLM из LanguageToolProcessorModule
  - [x] Обновить документацию и changelog
- **Зависимости**: LanguageToolProcessorModule, AutocorrectProcessorModule

## Задача: Тестирование новых файлов через пайплайн
- **Статус**: Завершена
- **Описание**: Провести тестирование пяти новых файлов через полный цикл обработки (DOCX → HTML → типографика → LanguageTool → автокоррекция → DOCX) и убедиться в корректности работы системы.
- **Шаги выполнения**:
  - [x] Запустить пайплайн для каждого файла
  - [x] Проверить логи и финальные DOCX-файлы
  - [x] Зафиксировать результаты в changelog и tasktracker
- **Зависимости**: Автоматизация пайплайна, корректная работа всех модулей

## Задача: Реализация сохранения итогового HTML файла
- **Статус**: Завершена
- **Описание**: Реализация сохранения итогового HTML файла в директории output для последующей конвертации в другие форматы
- **Шаги выполнения**:
  - [x] Добавление константы OUTPUT_DIR
  - [x] Создание директории output при инициализации
  - [x] Реализация копирования итогового HTML файла
  - [x] Добавление информации в статус пайплайна
  - [x] Обновление документации
- **Зависимости**: Нет
- **Приоритет**: Критический
- **Дата завершения**: 31.07.2024

## Задача: Оптимизация работы с HTML файлами
- **Статус**: Завершена
- **Описание**: Оптимизация процесса сохранения и использования HTML файлов в пайплайне
- **Шаги выполнения**:
  - [x] Анализ текущего процесса работы с HTML файлами
  - [x] Удаление избыточного создания final.html
  - [x] Использование output_from_stage4_html для конвертации
  - [x] Сохранять итоговый HTML с именем исходного файла в output
  - [x] Обновление документации
- **Зависимости**: Нет

## Задача: Универсализация обработки файлов и поддержка новых форматов
- **Статус**: Завершена
- **Описание**: Расширить поддержку загрузки, обработки, скачивания и удаления файлов для всех основных форматов (docx, pdf, epub, html и др.), обеспечить универсальное формирование имени результата и корректное отображение оригинального имени файла.
- **Шаги выполнения**:
  - [x] Проанализировать текущую логику загрузки, очереди и формирования имени результата
  - [x] Расширить ALLOWED_EXTENSIONS и универсализировать обработку
  - [x] Унифицировать формирование имени результата для всех форматов
  - [x] Обновить логику скачивания и удаления файлов
  - [x] Проверить корректность отображения в интерфейсе
  - [x] Обновить changelog и tasktracker
- **Зависимости**: Требования к поддерживаемым форматам, архитектура пайплайна

## Задача: Универсальное именование итоговых файлов в пайплайне
- **Статус**: Завершена
- **Описание**: Обеспечить, чтобы итоговые файлы в workspace/output всегда формировались с использованием оригинального имени пользователя ([basename]_final.[ext]) для всех поддерживаемых форматов.
- **Шаги выполнения**:
  - [x] Проанализировать логику формирования имён на всех этапах пайплайна
  - [x] Добавить передачу basename в docx_to_html_converter.py и html_to_docx_processor_module.py
  - [x] Обновить orchestrator.py для передачи basename на каждом этапе
  - [x] Провести тестирование для разных форматов и имён
  - [x] Обновить changelog и tasktracker
- **Зависимости**: Требования к поддерживаемым форматам, архитектура пайплайна

## Задача: Итоговые файлы строго по оригинальному имени пользователя
- **Статус**: Завершена
- **Описание**: Обеспечить, чтобы итоговые файлы в workspace/output всегда формировались строго по оригинальному имени пользователя (basename), даже если имя содержит пробелы, запятые и кириллицу.
- **Шаги выполнения**:
  - [x] Проанализировать логику формирования итоговых имён в orchestrator.py
  - [x] Исправить orchestrator.py для использования только переданного basename
  - [x] Провести тестирование с именами, содержащими пробелы, запятые, кириллицу
  - [x] Обновить changelog и tasktracker
- **Зависимости**: Требования к поддерживаемым форматам, архитектура пайплайна

## Задача: Усиление контроля lang="ru" для LanguageTool
- **Статус**: Завершена
- **Описание**: Функция ensure_html_lang_ru теперь вызывается непосредственно в LanguageToolProcessorModule, что гарантирует корректную работу LanguageTool на любом этапе пайплайна.
- **Шаги выполнения**:
  - [x] Импортировать функцию ensure_html_lang_ru в LanguageToolProcessorModule
  - [x] Встроить вызов функции в метод run
  - [x] Обновить changelog.md, tasktracker.md, Project.md
  - [x] Провести ручной тест
- **Зависимости**: LanguageToolProcessorModule, tools/check_text_languagetool.py

## Задача: Расширенное логирование содержимого временного .txt-файла для LanguageTool
- **Статус**: Завершена
- **Описание**: Добавить явный вывод содержимого временного .txt-файла (уникальная метка, кодировка, длина текста) в stdout/stderr и отдельный лог-файл для диагностики проблем с определением языка.
- **Шаги выполнения**:
  - [x] Добавить print с уникальной меткой в stdout/stderr
  - [x] Дублировать вывод в workspace/logs/langtool_debug.log
  - [x] Обновить changelog.md и tasktracker.md
- **Зависимости**: Диагностика работы LanguageTool, автоматизация контроля языка

## Задача: Корректная обработка stderr LanguageTool
- **Статус**: Завершена
- **Описание**: Исключить ложные ошибки пайплайна из-за информационных сообщений LanguageTool (например, 'Expected text language: Russian'). Ошибка фиксируется только при критических сообщениях или returncode != 0.
- **Шаги выполнения**:
  - [x] Проанализировать текущую обработку stderr
  - [x] Внести фильтрацию нефатальных сообщений
  - [x] Обновить changelog.md и tasktracker.md
- **Зависимости**: Диагностика работы LanguageTool, автоматизация контроля языка

## Задача: Явное копирование итоговых файлов в workspace/output/
- **Статус**: Завершена
- **Описание**: После успешного завершения пайплайна orchestrator.py явно копирует итоговые файлы (HTML и DOCX) в workspace/output/. Добавлено подробное логирование этого этапа.
- **Шаги выполнения**:
  - [x] Добавить копирование итоговых файлов в orchestrator.py
  - [x] Реализовать подробное логирование этапа копирования
  - [x] Обновить changelog.md и tasktracker.md
- **Зависимости**: Корректная выдача результатов пайплайна, интеграция с webapp

## Задача: Внедрение передачи имени файла между этапами пайплайна через meta-файл
- **Статус**: Завершена
- **Описание**: Реализовать механизм передачи имени (пути) файла между этапами пайплайна через временный meta-файл с уникальным correlation_id для устойчивой работы в Docker и при параллельной обработке.
- **Шаги выполнения**:
  - [x] Проанализировать текущую логику передачи имени файла
  - [x] Разработать архитектурное решение с meta-файлом
  - [x] Внедрить механизм в orchestrator.py
  - [x] Протестировать пайплайн на Docker и локально
  - [x] Обновить документацию
- **Зависимости**: src/pipeline/orchestrator.py, Docker-окружение

## Задача: Удалить fallback-логику python-docx из пайплайна
- **Статус**: Завершена
- **Описание**: Удалить аварийный этап извлечения текста из DOCX через python-docx (output_full_utf8.txt) и все связанные импорты/вызовы. Оставить только Pandoc для DOCX → HTML.
- **Шаги выполнения**:
  - [x] Найти и удалить все импорты и вызовы python-docx
  - [x] Удалить блок fallback-логики в orchestrator.py
  - [x] Проверить отсутствие вызовов extract_full_text и output_full_utf8.txt
  - [x] Обновить changelog, project.md, tasktracker.md
- **Зависимости**: Нет

## Задача: Исследовать и протестировать развертывание на Render.com
- **Статус**: Не начата
- **Приоритет**: Критический
- **Описание**: Из-за ограничений по памяти на бесплатном тарифе Railway (300 МБ), которые приводят к падению LanguageTool (OOM Killer), необходимо протестировать развертывание приложения на платформе Render.com. Render предоставляет 512 МБ RAM на бесплатном тарифе.
- **Шаги выполнения**:
  - [x] Адаптировать параметр `-Xmx` для LanguageTool на `-Xmx256m`.
  - [ ] Создать и настроить сервис на Render.com (Web Service или Private Service из Dockerfile).
  - [ ] Подключить репозиторий GitHub к Render для автоматических сборок.
  - [ ] Перенести все необходимые переменные окружения в настройки сервиса Render.
  - [ ] Запустить первый деплой на Render.
  - [ ] Протестировать полный цикл обработки DOCX файла.
  - [ ] Проанализировать логи и использование ресурсов на Render. (Добавлено улучшенное логирование stdout/stderr пайплайна в webapp/app.py; добавлены детальные [LT_DEBUG] логи; усилены проверки на фактический успех LanguageTool в LanguageToolProcessorModule).
  - [ ] Принять решение о миграции или дальнейших действиях.
- **Зависимости**: Отсутствие стабильной работы на Railway.

## (Последующие этапы и задачи будут добавлены позже)